{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<style>
/* Dashboard-specific gradient headers using blue-gray palette */
.dashboard .card-header.gradient-rich-black {
    background: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}linear-gradient(135deg, rgba(23, 26, 33, 0.9) 0%, rgba(97, 112, 115, 0.7) 100%){% else %}linear-gradient(135deg, rgba(23, 26, 33, 0.95) 0%, rgba(97, 112, 115, 0.8) 100%){% endif %} !important;
    color: white !important;
}
.dashboard .card-header.gradient-air-blue {
    background: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}linear-gradient(135deg, rgba(122, 147, 172, 0.9) 0%, rgba(146, 188, 234, 0.7) 100%){% else %}linear-gradient(135deg, rgba(122, 147, 172, 0.95) 0%, rgba(146, 188, 234, 0.8) 100%){% endif %} !important;
    color: white !important;
}
.dashboard .card-header.gradient-periwinkle-blue {
    background: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}linear-gradient(135deg, rgba(146, 188, 234, 0.9) 0%, rgba(175, 179, 247, 0.7) 100%){% else %}linear-gradient(135deg, rgba(146, 188, 234, 0.95) 0%, rgba(175, 179, 247, 0.8) 100%){% endif %} !important;
    color: white !important;
}

/* Button styling using blue-gray palette */
.dashboard .btn-primary {
    background: linear-gradient(135deg, #7A93AC 0%, #92BCEA 100%) !important;
    border: none !important;
    color: white !important;
    font-weight: 600 !important;
    transition: all 0.3s ease !important;
}

.dashboard .btn-primary:hover {
    background: linear-gradient(135deg, #6b829a 0%, #7ea8d8 100%) !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 4px 12px rgba(122, 147, 172, 0.4) !important;
}

.dashboard .btn-outline-primary {
    border: 2px solid #7A93AC !important;
    color: #7A93AC !important;
    background: transparent !important;
    font-weight: 600 !important;
}

.dashboard .btn-outline-primary:hover {
    background: #7A93AC !important;
    color: white !important;
    transform: translateY(-1px) !important;
}

/* Status badges using blue-gray palette */
.dashboard .badge-status-open,
.dashboard .badge-status-in_progress {
    background: linear-gradient(135deg, #92BCEA, #AFB3F7) !important;
    color: white !important;
}

.dashboard .badge-status-resolved,
.dashboard .badge-status-closed {
    background: linear-gradient(135deg, #617073, #171A21) !important;
    color: white !important;
}
</style>
<div class="dashboard">
<div class="container-fluid">
    <div class="row">
        <!-- Main Content Area -->
        <div class="col-md-8">
            <div class="row h-100">
                <!-- Top Left: Ticket Information -->
                <div class="col-12 mb-4">
                    <div class="card h-100">
                        <div class="card-header text-white gradient-rich-black">
                            <h5 class="mb-0">
                                <i data-feather="alert-circle"></i>
                                Active Tickets
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if recent_tickets %}
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th>Priority</th>
                                                <th>Title</th>
                                                <th>Status</th>
                                                <th>Assigned To</th>
                                                <th>Created</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for ticket in recent_tickets %}
                                            <tr onclick="location.href='{{ url_for('tickets.view_ticket', ticket_id=ticket.id) }}'" style="cursor: pointer; {% if ticket.has_unread_activity %}background-color: rgba(255, 215, 0, 0.1); border-left: 4px solid #ffc107;{% endif %}">
                                                <td>
                                                    <span class="badge badge-priority-{{ ticket.priority }}">
                                                        {% if ticket.priority == 0 %}Low
                                                        {% elif ticket.priority == 1 %}Medium
                                                        {% elif ticket.priority == 2 %}High
                                                        {% else %}Urgent{% endif %}
                                                    </span>
                                                </td>
                                                <td>
                                                    {{ ticket.title[:50] }}{% if ticket.title|length > 50 %}...{% endif %}
                                                    {% if ticket.has_unread_activity %}
                                                        <span class="badge bg-danger rounded-pill ms-2" style="font-size: 0.6rem; padding: 0.15rem 0.3rem; animation: pulse 2s infinite;">NEW</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <span class="badge badge-status-{{ ticket.status }}">
                                                        {{ ticket.status.replace('_', ' ').title() }}
                                                    </span>
                                                </td>
                                                <td>
                                                    {% if ticket.assigned_to %}
                                                        {{ ticket.assigned_technician.username }}
                                                    {% else %}
                                                        <span class="text-muted">Unassigned</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ ticket.created_at.astimezone(current_user.get_timezone_obj()).strftime('%m/%d %H:%M') }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="text-center mt-3">
                                    <a href="{{ url_for('tickets.tickets_dashboard') }}" class="btn btn-primary btn-sm">
                                        <i data-feather="list"></i> View All Tickets
                                    </a>
                                </div>
                            {% else %}
                                <div class="text-center text-muted py-4">
                                    <i data-feather="check-circle" class="mb-2" style="width: 48px; height: 48px;"></i>
                                    <p>No active tickets at the moment!</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Bottom Left: Studio Calendar Bookings -->
                <div class="col-12">
                    <div class="card h-100">
                        <div class="card-header text-white gradient-air-blue">
                            <h5 class="mb-0">
                                <i data-feather="calendar"></i>
                                Studio Bookings - {{ today.strftime('%A, %B %d') }}
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="studio-bookings-content">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="sr-only">Loading...</span>
                                    </div>
                                    <p class="mt-2 text-muted">Loading studio bookings...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Side: Today's Technician Schedules -->
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-header text-white gradient-periwinkle-blue">
                    <h5 class="mb-0">
                        <i data-feather="users"></i>
                        Today's Schedule - {{ today.strftime('%a %m/%d') }}
                    </h5>
                </div>
                <div class="card-body p-0">
                    {% if schedules_by_tech %}
                        <!-- Single Day Timeline - Exact Calendar Copy -->
                        <div class="calendar-grid" style="grid-template-columns: 80px 1fr; border-radius: 8px; overflow: hidden;">
                            <!-- Time Column -->
                            <div class="time-column">
                                {% for hour in range(24) %}
                                    <div class="hour-slot">{{ "%02d:00"|format(hour) }}</div>
                                {% endfor %}
                            </div>
                            
                            <!-- Day Column -->
                            <div class="day-column">
                                <div class="day-header">
                                    {{ today.strftime('%a %m/%d') }}
                                </div>
                                <div class="day-slots" data-date="{{ today.strftime('%Y-%m-%d') }}">
                                    {% for hour in range(24) %}
                                        <div class="time-slot" data-hour="{{ '%02d'|format(hour) }}"></div>
                                    {% endfor %}
                                    <div class="current-time-line" data-time=""></div>
                                    
                                    {% set all_schedules = [] %}
                                    {% for tech_name, tech_data in schedules_by_tech.items() %}
                                        {% for schedule in tech_data.schedules %}
                                            {% set _ = all_schedules.append(schedule) %}
                                        {% endfor %}
                                    {% endfor %}
                                    
                                    {% for schedule in all_schedules %}
                                        <div class="schedule-event"
                                             style="--user-color: {{ '#6a6d6c' if schedule.time_off else schedule.technician.color }};"
                                             data-schedule-id="{{ schedule.id }}"
                                             data-technician-id="{{ schedule.technician_id }}"
                                             data-start-time="{{ schedule.start_time.astimezone(current_user.get_timezone_obj()).strftime('%Y-%m-%d %H:%M:%S') }}"
                                             data-end-time="{{ schedule.end_time.astimezone(current_user.get_timezone_obj()).strftime('%Y-%m-%d %H:%M:%S') }}"
                                             data-time-off="{{ 'true' if schedule.time_off else 'false' }}"
                                             data-all-day="{{ 'true' if (schedule.time_off and schedule.all_day) else 'false' }}"
                                             data-user-color="{{ '#6a6d6c' if schedule.time_off else schedule.technician.color }}"
                                             data-profile-picture="{{ schedule.technician.profile_picture if schedule.technician.profile_picture else '' }}"
                                             data-username="{{ schedule.technician.username }}"
">
                                            <div class="schedule-header">
                                                <div class="schedule-title">{{ schedule.technician.username }}{% if schedule.time_off %} - Time Off{% endif %}</div>
                                                <div class="schedule-time">
                                                    {% set user_tz = current_user.get_timezone_obj() %}
                                                    {% set start_local = schedule.start_time.astimezone(user_tz) %}
                                                    {% set end_local = schedule.end_time.astimezone(user_tz) %}
                                                    {% if end_local.date() > start_local.date() %}
                                                        {{ start_local.strftime('%H:%M') }} - {{ end_local.strftime('%H:%M') }} <span style="font-size: 0.8em; opacity: 0.8;">(+1)</span>
                                                    {% else %}
                                                        {{ start_local.strftime('%H:%M') }} - {{ end_local.strftime('%H:%M') }}
                                                    {% endif %}
                                                </div>
                                                {% if schedule.location %}
                                                <div class="schedule-location">
                                                    <i data-feather="map-pin"></i>
                                                    {{ schedule.location.name }}
                                                </div>
                                                {% else %}
                                                <div class="schedule-location">
                                                    <i data-feather="map-pin"></i>
                                                    Plex
                                                </div>
                                                {% endif %}
                                                {% if schedule.description %}
                                                <div class="schedule-desc">{{ schedule.description }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i data-feather="calendar" class="mb-2" style="width: 48px; height: 48px;"></i>
                            <p>No technician schedules for today</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Priority badges */
.badge-priority-0 { background-color: #28a745; }
.badge-priority-1 { background-color: #ffc107; color: #212529; }
.badge-priority-2 { background-color: #fd7e14; }
.badge-priority-3 { background-color: #dc3545; }

/* Status badges */
.badge-status-open { background-color: #007bff; }
.badge-status-in_progress { background-color: #ffc107; color: #212529; }
.badge-status-pending { background-color: #6f42c1; }
.badge-status-resolved { background-color: #28a745; }
.badge-status-closed { background-color: #6c757d; }

/* Single Day Timeline - Absolute Positioning */
.single-day-timeline {
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid rgba(255,255,255,0.1);
}

.timeline-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px;
    text-align: center;
    font-weight: bold;
    font-size: 16px;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
}

.timeline-container-absolute {
    position: relative;
    height: 1440px; /* 24 hours * 60px per hour */
    width: 100%;
    background: #f8f9fa;
}

.schedule-block-positioned {
    position: absolute;
    left: 0;
    right: 0;
    width: 100%;
    color: white;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.4);
    border-radius: 0;
    border: 1px solid rgba(255,255,255,0.2);
    box-sizing: border-box;
    z-index: 10;
}

.schedule-header-abs {
    padding: 8px 12px;
    width: 100%;
    height: 100%;
    box-sizing: border-box;
}

.schedule-title-abs {
    font-weight: bold;
    font-size: 14px;
    margin-bottom: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.schedule-time-abs {
    font-weight: 600;
    font-size: 12px;
    margin-bottom: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.schedule-location-abs {
    font-size: 10px;
    opacity: 0.9;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.time-grid-line {
    position: absolute;
    left: 0;
    right: 0;
    height: 1px;
    border-top: 1px solid #e9ecef;
    z-index: 1;
}

.time-label-abs {
    position: absolute;
    left: -60px;
    top: -8px;
    width: 50px;
    font-size: 11px;
    font-weight: 600;
    color: #6c757d;
    text-align: right;
    background: #f8f9fa;
    padding: 2px 4px;
}



.current-time-bar {
    background-color: #dc3545;
    color: white;
    padding: 12px;
    text-align: center;
    font-weight: bold;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

/* Booking item styling */
.booking-item {
    border-left: 4px solid #007bff;
    background-color: rgba(0, 123, 255, 0.05);
    transition: all 0.2s ease;
}

.booking-item:hover {
    background-color: rgba(0, 123, 255, 0.1);
    transform: translateX(2px);
}

/* Spinning animation for refresh icon */
.spin-icon {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Pulse animation for NEW badges */
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .col-md-8, .col-md-4 {
        margin-bottom: 1rem;
    }
    
    .card-body {
        padding: 0.75rem;
    }
    
    .table-responsive {
        font-size: 0.875rem;
    }
}
</style>

<style>
/* Dashboard Timeline Styling - Mobile-inspired profile pictures and duration lines */
.dashboard-timeline-duration-line {
    position: absolute;
    border-radius: 2px;
    transition: all 0.2s ease;
}

.dashboard-timeline-duration-line:hover {
    transform: scaleX(1.5);
    box-shadow: 0 0 8px rgba(0,0,0,0.3);
}

.dashboard-timeline-profile {
    position: absolute;
    cursor: pointer;
    transition: all 0.2s ease;
}

.dashboard-timeline-profile:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 16px rgba(0,0,0,0.4) !important;
}

/* Clean timeline area for better visibility */
.day-schedules {
    position: relative;
    overflow: visible;
}

/* Enhanced OOO styling for dashboard */
.dashboard .all-day-time-off {
    border: 2px dashed #cc5500 !important;
    background: linear-gradient(135deg, #fff4e6 0%, #ffe8cc 100%) !important;
    border-radius: 8px !important;
    box-shadow: 0 2px 8px rgba(204, 85, 0, 0.3) !important;
}

.dashboard .all-day-time-off .schedule-title {
    font-weight: bold !important;
    color: white !important;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3) !important;
    text-transform: uppercase !important;
    letter-spacing: 0.5px !important;
}
</style>

<script>
// Pass timezone from server to client for schedule positioning
window.userTimezone = '{{ user_timezone }}';

document.addEventListener('DOMContentLoaded', function() {
    // Load studio bookings initially
    loadStudioBookings();
    
    // Set up auto-refresh for studio bookings every 3 minutes (180,000 ms)
    setInterval(function() {
        console.log('Auto-refreshing studio bookings...');
        loadStudioBookings();
    }, 180000);
    
    // Set up auto-refresh for dashboard tickets every 60 seconds
    setInterval(function() {
        refreshDashboardTickets();
    }, 60000);
    
    // Initialize Feather icons
    feather.replace();
});

function loadStudioBookings() {
    // Show subtle loading indicator in the header
    const header = document.querySelector('.card-header h5');
    if (header) {
        const originalText = header.innerHTML;
        if (!originalText.includes('spinner')) {
            header.innerHTML = originalText + ' <span class="ml-2 text-light" style="font-size: 0.8em;"><i data-feather="refresh-cw" class="spin-icon" style="width: 12px; height: 12px;"></i></span>';
            feather.replace();
        }
    }
    
    fetch('/api/studio-bookings')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('studio-bookings-content');
            
            if (data.success && data.bookings && data.bookings.length > 0) {
                let html = '<div class="booking-list">';
                
                data.bookings.forEach(booking => {
                    const startTime = new Date(booking.start).toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true,
                        timeZone: '{{ current_user.get_timezone() }}'
                    });
                    const endTime = new Date(booking.end).toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true,
                        timeZone: '{{ current_user.get_timezone() }}'
                    });
                    
                    // Determine status badge color and icon
                    let statusColor = 'secondary';
                    let statusIcon = 'calendar';
                    if (booking.status === 'confirmed') {
                        statusColor = 'success';
                        statusIcon = 'check-circle';
                    } else if (booking.status === 'cancelled') {
                        statusColor = 'danger';
                        statusIcon = 'x-circle';
                    } else if (booking.status === 'pending') {
                        statusColor = 'warning';
                        statusIcon = 'clock';
                    }

                    // Detect dark mode for booking styling
                    const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark';
                    const bgColor = isDarkMode ? '#2d2d2d' : 'var(--bs-light)';
                    const titleColor = isDarkMode ? '#ffffff' : '#000000';
                    const borderColor = isDarkMode ? '#3a3a3a' : '#dee2e6';

                    html += `
                        <div class="booking-item p-3 mb-3 rounded border" style="background-color: ${bgColor}; border: 1px solid ${borderColor}; border-left: 4px solid ${booking.color || '#007bff'} !important;">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="flex-grow-1">
                                    <div class="booking-title font-weight-bold mb-1" style="color: ${titleColor};">
                                        ${booking.title || 'Studio Booking'}
                                    </div>
                                    <div class="booking-time text-primary mb-2">
                                        <i data-feather="clock" style="width: 14px; height: 14px;"></i>
                                        ${startTime} - ${endTime}
                                    </div>
                                </div>
                                <span class="badge bg-${statusColor} ms-2">
                                    <i data-feather="${statusIcon}" style="width: 12px; height: 12px;"></i>
                                    ${booking.status.charAt(0).toUpperCase() + booking.status.slice(1)}
                                </span>
                            </div>
                            
                            <div class="row g-2 text-sm">
                                ${booking.description ? `
                                <div class="col-12">
                                    <div class="booking-description small" style="color: ${isDarkMode ? '#b0b0b0' : '#6c757d'};">
                                        <i data-feather="file-text" style="width: 12px; height: 12px;"></i>
                                        ${booking.description}
                                    </div>
                                </div>` : ''}
                                
                                <div class="col-md-6">
                                    <div class="booking-type small" style="color: ${isDarkMode ? '#b0b0b0' : '#6c757d'};">
                                        <i data-feather="tag" style="width: 12px; height: 12px;"></i>
                                        ${booking.type.charAt(0).toUpperCase() + booking.type.slice(1)}
                                    </div>
                                </div>
                                
                                ${booking.severity ? `
                                <div class="col-md-6">
                                    <div class="booking-severity small text-warning">
                                        <i data-feather="alert-triangle" style="width: 12px; height: 12px;"></i>
                                        ${booking.severity}
                                    </div>
                                </div>` : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
            } else if (data.success && (!data.bookings || data.bookings.length === 0)) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i data-feather="calendar-x" class="mb-2" style="width: 48px; height: 48px;"></i>
                        <p>No studio bookings for today</p>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="text-center text-warning py-4">
                        <i data-feather="alert-triangle" class="mb-2" style="width: 48px; height: 48px;"></i>
                        <p>Unable to load studio bookings</p>
                        <small class="text-muted">${data.error || 'Unknown error'}</small>
                    </div>
                `;
            }
            
            // Remove loading indicator from header
            const header = document.querySelector('.card-header h5');
            if (header && header.innerHTML.includes('spin-icon')) {
                header.innerHTML = header.innerHTML.replace(/ <span class="ml-2 text-light".*?<\/span>/, '');
            }
            
            // Re-initialize Feather icons for the new content
            feather.replace();
        })
        .catch(error => {
            console.error('Error loading studio bookings:', error);
            document.getElementById('studio-bookings-content').innerHTML = `
                <div class="text-center text-danger py-4">
                    <i data-feather="wifi-off" class="mb-2" style="width: 48px; height: 48px;"></i>
                    <p>Connection error</p>
                    <small class="text-muted">Please check your internet connection</small>
                </div>
            `;
            
            // Remove loading indicator from header
            const header = document.querySelector('.card-header h5');
            if (header && header.innerHTML.includes('spin-icon')) {
                header.innerHTML = header.innerHTML.replace(/ <span class="ml-2 text-light".*?<\/span>/, '');
            }
            
            feather.replace();
        });
}

function refreshDashboardTickets() {
    // Don't refresh if the tab is hidden to save resources
    if (document.hidden) {
        return;
    }
    
    console.log('Auto-refreshing dashboard tickets...');
    
    fetch('/dashboard', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.text())
    .then(html => {
        // Create a temporary DOM to parse the response
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // Extract the Active Tickets table body
        const newTicketsBody = doc.querySelector('.table tbody');
        const currentTicketsBody = document.querySelector('.table tbody');
        
        if (newTicketsBody && currentTicketsBody) {
            currentTicketsBody.innerHTML = newTicketsBody.innerHTML;
            console.log('Dashboard tickets refreshed successfully');
        }
        
        // Re-initialize Feather icons
        feather.replace();
    })
    .catch(error => {
        console.error('Error refreshing dashboard tickets:', error);
    });
}

// Position schedule events in the timeline - Using working main calendar logic
function positionSchedules() {
    console.log('Dashboard positionSchedules called');
    const daySlots = document.querySelectorAll('.day-slots');
    console.log('Found day slots:', daySlots.length);
    
    daySlots.forEach(daySlot => {
        const events = daySlot.querySelectorAll('.schedule-event');
        console.log('Found schedule events:', events.length);
        const eventArray = Array.from(events);

        // Sort events by start time
        eventArray.sort((a, b) => {
            const aStart = new Date(a.dataset.startTime);
            const bStart = new Date(b.dataset.startTime);
            return aStart - bStart;
        });

        // Find overlapping groups - using main calendar logic
        const overlappingGroups = [];

        eventArray.forEach(event => {
            let foundGroup = false;
            const eventStart = new Date(event.dataset.startTime);
            const eventEnd = new Date(event.dataset.endTime);

            // Normalize end time - treat 00:00 as 24:00
            const normalizedEndHour = eventEnd.getHours() === 0 && eventEnd.getMinutes() === 0 
                ? 24 
                : eventEnd.getHours() + eventEnd.getMinutes() / 60;

            // Check if event overlaps with any existing group
            for (let group of overlappingGroups) {
                const overlapsWithGroup = group.some(existingEvent => {
                    const existingStart = new Date(existingEvent.dataset.startTime);
                    const existingEnd = new Date(existingEvent.dataset.endTime);
                    const existingEndHour = existingEnd.getHours() === 0 && existingEnd.getMinutes() === 0 
                        ? 24 
                        : existingEnd.getHours() + existingEnd.getMinutes() / 60;

                    return (
                        eventStart < (existingEndHour === 24 ? new Date(existingEnd).setHours(24, 0, 0) : existingEnd) && 
                        (normalizedEndHour === 24 ? new Date(eventEnd).setHours(24, 0, 0) : eventEnd) > existingStart
                    );
                });

                if (overlapsWithGroup) {
                    group.push(event);
                    foundGroup = true;
                    break;
                }
            }

            // If no overlapping group found, create new group
            if (!foundGroup) {
                overlappingGroups.push([event]);
            }
        });

        // Merge overlapping groups
        for (let i = overlappingGroups.length - 1; i > 0; i--) {
            for (let j = i - 1; j >= 0; j--) {
                const groupOverlaps = overlappingGroups[i].some(event1 => 
                    overlappingGroups[j].some(event2 => {
                        const start1 = new Date(event1.dataset.startTime);
                        const end1 = new Date(event1.dataset.endTime);
                        const end1Hour = end1.getHours() === 0 && end1.getMinutes() === 0 ? 24 : end1.getHours() + end1.getMinutes() / 60;

                        const start2 = new Date(event2.dataset.startTime);
                        const end2 = new Date(event2.dataset.endTime);
                        const end2Hour = end2.getHours() === 0 && end2.getMinutes() === 0 ? 24 : end2.getHours() + end2.getMinutes() / 60;

                        return (
                            start1 < (end2Hour === 24 ? new Date(end2).setHours(24, 0, 0) : end2) && 
                            (end1Hour === 24 ? new Date(end1).setHours(24, 0, 0) : end1) > start2
                        );
                    })
                );
                
                if (groupOverlaps) {
                    overlappingGroups[j].push(...overlappingGroups[i]);
                    overlappingGroups.splice(i, 1);
                    break;
                }
            }
        }

        console.log('Found overlapping groups:', overlappingGroups.length);

        // Position events vertically first
        eventArray.forEach(event => {
            const startTime = new Date(event.dataset.startTime);
            const endTime = new Date(event.dataset.endTime);
            const startHour = startTime.getHours() + startTime.getMinutes() / 60;
            let endHour = endTime.getHours() + endTime.getMinutes() / 60;
            const isTimeOff = event.dataset.timeOff === 'true';

            // Special handling for all-day time-off events using data attribute
            const isAllDay = event.dataset.allDay === 'true';
            
            // Debug all-day detection for dashboard
            if (isTimeOff) {
                console.log('Dashboard time-off event debug:', {
                    scheduleId: event.dataset.scheduleId,
                    startTime: event.dataset.startTime,
                    endTime: event.dataset.endTime,
                    dataAllDay: event.dataset.allDay,
                    isAllDay: isAllDay,
                    startHour: startHour,
                    endHour: endHour
                });
            }
            
            if (isTimeOff && isAllDay) {
                // Position as compact "OOO all day" entry in 00:00 slot only
                event.style.top = '0px';
                event.style.height = '60px'; // Height of one time slot
                event.style.position = 'absolute';
                event.classList.add('all-day-time-off');
                
                // Apply enhanced styling for better visibility
                event.style.setProperty('border', '2px dashed #cc5500', 'important');
                event.style.setProperty('background', 'linear-gradient(135deg, #fff4e6 0%, #ffe8cc 100%)', 'important');
                event.style.setProperty('border-radius', '8px', 'important');
                event.style.setProperty('box-shadow', '0 2px 8px rgba(204, 85, 0, 0.3)', 'important');
                
                // Add vacation emoji icon
                if (!event.querySelector('.vacation-icon')) {
                    const icon = document.createElement('span');
                    icon.className = 'vacation-icon';
                    icon.textContent = '🏖️';
                    icon.style.cssText = 'position: absolute; top: 2px; right: 4px; font-size: 14px; opacity: 0.7;';
                    event.appendChild(icon);
                }
                
                // Update the display text to show "OOO all day"
                const scheduleTitle = event.querySelector('.schedule-title');
                if (scheduleTitle) {
                    const username = scheduleTitle.textContent.replace(' - Time Off', '');
                    scheduleTitle.textContent = username + ' - OOO ALL DAY';
                    scheduleTitle.style.setProperty('font-weight', 'bold', 'important');
                    scheduleTitle.style.setProperty('color', 'white', 'important');
                    scheduleTitle.style.setProperty('text-shadow', '1px 1px 2px rgba(0, 0, 0, 0.3)', 'important');
                    scheduleTitle.style.setProperty('text-transform', 'uppercase', 'important');
                    scheduleTitle.style.setProperty('letter-spacing', '0.5px', 'important');
                }
                
                // Hide the time display for all-day events
                const scheduleTime = event.querySelector('.schedule-time');
                if (scheduleTime) {
                    scheduleTime.style.display = 'none';
                }
            } else {
                // Normal event positioning
                // Special handling for midnight (00:00) as end time
                if (endHour === 0) {
                    endHour = 24;
                }

                const top = startHour * 60;
                const height = (endHour - startHour) * 60;

                event.style.top = `${top}px`;
                event.style.height = `${height}px`;
                event.style.position = 'absolute';
            }
        });

        // Apply mobile timeline styling - create profile pictures and duration lines
        const processedEvents = [];
        const maxColumns = 4;
        
        console.log('Processing events for timeline styling, found:', eventArray.length);
        
        eventArray.forEach((event, index) => {
            try {
                console.log(`Processing event ${index + 1}:`, {
                    startTime: event.dataset.startTime,
                    endTime: event.dataset.endTime,
                    userColor: event.dataset.userColor,
                    timeOff: event.dataset.timeOff,
                    allDay: event.dataset.allDay
                });
                
                const startTime = new Date(event.dataset.startTime);
                const endTime = new Date(event.dataset.endTime);
                const startHour = startTime.getHours();
                const startMinute = startTime.getMinutes();
                let endHour = endTime.getHours();
                const endMinute = endTime.getMinutes();
                const userColor = event.dataset.userColor;
                const isTimeOff = event.dataset.timeOff === 'true';
                const isAllDay = event.dataset.allDay === 'true';
                
                // Skip all-day time-off events - they're handled separately above
                if (isTimeOff && isAllDay) {
                    console.log('Skipping all-day time-off event');
                    return;
                }
                
                // Completely hide the original event since we're creating timeline elements
                event.style.display = 'none';
                
                // Calculate time positions
                const startTotalMinutes = startHour * 60 + startMinute;
                let endTotalMinutes;
                
                // Handle midnight crossings
                if (endHour === 0 && startHour > 0) {
                    endHour = 24;
                }
                endTotalMinutes = endHour * 60 + endMinute;
                
                console.log(`Event ${index + 1} time range:`, {
                    startMinutes: startTotalMinutes,
                    endMinutes: endTotalMinutes,
                    duration: endTotalMinutes - startTotalMinutes
                });
                
                // Find horizontal position to avoid overlaps
                let column = 0;
                while (column < maxColumns) {
                    const hasOverlap = processedEvents.some(processedEvent => {
                        return processedEvent.column === column && 
                               processedEvent.startTime < endTotalMinutes && 
                               processedEvent.endTime > startTotalMinutes;
                    });
                    
                    if (!hasOverlap) break;
                    column++;
                }
                
                if (column >= maxColumns) column = 0;
                
                // Get event container for positioning
                const eventContainer = event.closest('.day-slots');
                if (!eventContainer) {
                    console.log('No event container found for event:', index + 1);
                    return;
                }
                
                // Event is hidden, so we don't need to clear innerHTML
                
                // Find which hour slots this event spans
                const startSlot = Math.floor(startTotalMinutes / 60);
                const endSlot = Math.ceil(endTotalMinutes / 60);
                
                console.log(`Creating timeline elements for slots ${startSlot} to ${endSlot}`);
                
                // Create duration lines for each hour slot
                for (let hour = startSlot; hour < Math.min(endSlot, 24); hour++) {
                    const slotStartMinutes = hour * 60;
                    const slotEndMinutes = (hour + 1) * 60;
                    const eventStartInSlot = Math.max(startTotalMinutes, slotStartMinutes);
                    const eventEndInSlot = Math.min(endTotalMinutes, slotEndMinutes);
                    
                    // Calculate position within the 60px hour slot
                    const topOffset = ((eventStartInSlot - slotStartMinutes) / 60) * 60;
                    const height = Math.max(((eventEndInSlot - eventStartInSlot) / 60) * 60, 10);
                    
                    // Create duration line
                    const durationLine = document.createElement('div');
                    durationLine.className = 'dashboard-timeline-duration-line';
                    durationLine.style.cssText = `
                        position: absolute;
                        top: ${hour * 60 + topOffset}px;
                        left: ${20 + column * 90}px;
                        width: 6px;
                        height: ${height}px;
                        background-color: ${userColor};
                        z-index: 4;
                        border-radius: 3px;
                    `;
                    
                    eventContainer.appendChild(durationLine);
                }
                
                // Create profile picture (only once, at the start position)
                const profilePic = document.createElement('div');
                profilePic.className = 'dashboard-timeline-profile';
                
                // Get user data from data attributes
                const username = event.dataset.username || 'User';
                const profilePicturePath = event.dataset.profilePicture;
                const initials = username.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                
                // Create profile picture with actual image or initials fallback
                if (profilePicturePath && profilePicturePath.trim() !== '') {
                    // Use actual profile picture (50% larger)
                    profilePic.style.cssText = `
                        width: 66px;
                        height: 66px;
                        border-radius: 50%;
                        background-image: url('/static/${profilePicturePath}');
                        background-size: cover;
                        background-position: center;
                        border: 3px solid white;
                        position: absolute;
                        z-index: 5;
                        cursor: pointer;
                        box-shadow: 0 3px 12px rgba(0,0,0,0.4);
                    `;
                } else {
                    // Use initials with user color background (50% larger)
                    profilePic.style.cssText = `
                        width: 66px;
                        height: 66px;
                        border-radius: 50%;
                        background-color: ${userColor};
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: bold;
                        font-size: 24px;
                        border: 3px solid white;
                        position: absolute;
                        z-index: 5;
                        cursor: pointer;
                        box-shadow: 0 3px 12px rgba(0,0,0,0.4);
                    `;
                    profilePic.textContent = initials;
                }
                
                // Position profile picture at the middle of the schedule duration (adjusted for larger size)
                const totalHeight = endTotalMinutes - startTotalMinutes;
                const profileTop = startTotalMinutes + Math.max(0, totalHeight/2 - 33);
                
                profilePic.style.top = `${profileTop}px`;
                profilePic.style.left = `${20 + column * 90 - 33}px`;
                
                console.log(`Profile positioned at top: ${profileTop}px, left: ${20 + column * 90 - 33}px`);
                
                eventContainer.appendChild(profilePic);
                
                // Store processed event info for overlap detection
                processedEvents.push({
                    startTime: startTotalMinutes,
                    endTime: endTotalMinutes,
                    column: column
                });
                
                console.log(`Event ${index + 1} processed successfully in column ${column}`);
                
            } catch (error) {
                console.error(`Error processing event ${index + 1}:`, error);
            }
        });
    });
}

// Initialize positions when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard DOMContentLoaded');
    setTimeout(() => {
        positionSchedules();
        updateCurrentTimeLine();
        feather.replace();
    }, 100);
    
    // Update current time line every minute
    setInterval(updateCurrentTimeLine, 60000);
});

// Function to update current time line position (using user's timezone)
function updateCurrentTimeLine() {
    const timeLine = document.querySelector('.current-time-line');
    if (!timeLine) return;
    
    // Get current time in user's timezone (same approach as main calendar)
    const now = new Date();
    const userTimezone = '{{ current_user.timezone }}' || 'UTC';
    
    let currentHour, currentMinute, timeString;
    
    try {
        // Get the current time in the user's timezone
        const timeInUserTimezone = new Intl.DateTimeFormat('en-US', {
            timeZone: userTimezone,
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        }).format(now);
        
        // Parse the formatted time
        const [hour, minute] = timeInUserTimezone.split(':').map(Number);
        currentHour = hour;
        currentMinute = minute;
        
        // Format time for display
        timeString = new Intl.DateTimeFormat('en-US', {
            timeZone: userTimezone,
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        }).format(now);
        
    } catch (error) {
        console.warn('Error getting time in user timezone, falling back to local time:', error);
        // Fallback to local time
        currentHour = now.getHours();
        currentMinute = now.getMinutes();
        timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
    
    const totalMinutes = currentHour * 60 + currentMinute;
    const topPosition = totalMinutes; // Each minute = 1 pixel
    
    timeLine.style.top = `${topPosition}px`;
    timeLine.style.display = 'block';
    timeLine.setAttribute('data-time', timeString);
    
    console.log('Current time line updated (user timezone):', `${currentHour}:${currentMinute.toString().padStart(2, '0')}`, 'position:', topPosition);
}
</script>
</div>
{% endblock %}