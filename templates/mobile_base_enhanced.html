<!DOCTYPE html>
<html lang="en" data-bs-theme="{% if current_user.is_authenticated and current_user.theme_preference == 'light' %}light{% else %}dark{% endif %}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ site_name }} - Tech Scheduler{% endblock %}</title>
    <!-- Favicon and mobile app icons -->
    <link rel="icon" href="{{ url_for('static', filename='favicon.png') }}" type="image/png">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='apple-touch-icon-180x180.png') }}" sizes="180x180">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='apple-touch-icon-152x152.png') }}" sizes="152x152">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='apple-touch-icon-120x120.png') }}" sizes="120x120">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#4A90B2">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}?v={{ now.timestamp() | int }}" rel="stylesheet">
    
    {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}
    <link href="{{ url_for('static', filename='css/light-theme.css') }}?v={{ now.timestamp() | int }}" rel="stylesheet">
    {% else %}
    <link href="{{ url_for('static', filename='css/dark-theme.css') }}?v={{ now.timestamp() | int }}" rel="stylesheet">
    {% endif %}
    
    <!-- Force Custom Color Palette - Mobile -->
    <style>
        html body .btn.btn-primary, 
        html body a.btn.btn-primary,
        html body button.btn.btn-primary {
            background: linear-gradient(135deg, #6E7E85 0%, #B7CECE 100%) !important;
            border-color: #6E7E85 !important;
            color: white !important;
        }
        
        html body .btn.btn-secondary,
        html body a.btn.btn-secondary,
        html body button.btn.btn-secondary {
            background: linear-gradient(135deg, #BBBAC6 0%, #E2E2E2 100%) !important;
            border-color: #BBBAC6 !important;
            color: #1C0F13 !important;
        }
    </style>
    
    <style>
        body {
            padding-bottom: 80px; /* Space for bottom nav */
            overflow-x: hidden;
        }
        
        html {
            overflow-x: hidden;
        }
        
        /* Top header - minimal and clean */
        .mobile-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}
            background: linear-gradient(120deg, #ffffff, #f8f9fa);
            border-bottom: 1px solid #e9ecef;
            color: #212529;
            {% else %}
            background: linear-gradient(120deg, #1a1a1a, #2d2d2d);
            border-bottom: 1px solid #3a3a3a;
            color: #ffffff;
            {% endif %}
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .mobile-header .logo {
            display: flex;
            align-items: center;
            font-weight: 700;
            font-size: 1.1rem;
            letter-spacing: 0.5px;
            min-width: 0;
            flex: 1;
        }
        
        .mobile-header .logo span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .mobile-header .logo img {
            height: 32px;
            width: auto;
            margin-right: 10px;
            flex-shrink: 0;
        }
        
        .mobile-header .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .theme-toggle {
            background: none;
            border: none;
            padding: 8px;
            border-radius: 50%;
            {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}
            color: #495057;
            {% else %}
            color: #ffffff;
            {% endif %}
            flex-shrink: 0;
        }
        
        /* Mobile header responsive styles */
        @media (max-width: 414px) {
            .mobile-header {
                padding: 0 16px;
            }
            
            .mobile-header .logo {
                font-size: 1rem;
                letter-spacing: 0.3px;
            }
            
            .mobile-header .logo img {
                height: 28px;
                margin-right: 8px;
            }
            
            .mobile-header .header-actions {
                gap: 12px;
            }
        }
        
        @media (max-width: 375px) {
            .mobile-header {
                padding: 0 14px;
            }
            
            .mobile-header .logo {
                font-size: 0.95rem;
                letter-spacing: 0.2px;
            }
            
            .mobile-header .logo img {
                height: 26px;
                margin-right: 6px;
            }
            
            .mobile-header .header-actions {
                gap: 10px;
            }
            
            .theme-toggle {
                padding: 6px;
            }
        }
        
        @media (max-width: 320px) {
            .mobile-header {
                padding: 0 12px;
            }
            
            .mobile-header .logo {
                font-size: 0.9rem;
                letter-spacing: 0.1px;
            }
            
            .mobile-header .logo img {
                height: 24px;
                margin-right: 5px;
            }
            
            .mobile-header .header-actions {
                gap: 8px;
            }
            
            .theme-toggle {
                padding: 5px;
            }
        }
        
        @media (max-width: 280px) {
            .mobile-header {
                padding: 0 10px;
            }
            
            .mobile-header .logo {
                font-size: 0.85rem;
                letter-spacing: 0;
            }
            
            .mobile-header .logo img {
                height: 22px;
                margin-right: 4px;
            }
            
            .mobile-header .header-actions {
                gap: 6px;
            }
            
            .theme-toggle {
                padding: 4px;
            }
        }
        
        /* Main content area */
        .mobile-content {
            margin-top: 60px;
            margin-bottom: 80px;
            padding: 20px 0px;
            min-height: calc(100vh - 140px);
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 80px;
            {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}
            background: linear-gradient(to top, #ffffff, #f8f9fa);
            border-top: 1px solid #e9ecef;
            {% else %}
            background: linear-gradient(to top, #1a1a1a, #2d2d2d);
            border-top: 1px solid #3a3a3a;
            {% endif %}
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 8px 0;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 12px;
            transition: all 0.3s ease;
            flex: 1;
            max-width: 80px;
            {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}
            color: #6c757d;
            {% else %}
            color: #adb5bd;
            {% endif %}
        }
        
        .nav-item:hover, .nav-item.active {
            {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}
            color: #007bff;
            background: rgba(0, 123, 255, 0.1);
            {% else %}
            color: #66d9ef;
            background: rgba(102, 217, 239, 0.1);
            {% endif %}
            text-decoration: none;
            transform: translateY(-2px);
        }
        
        .nav-item .nav-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
        }
        
        .nav-item .nav-label {
            font-size: 11px;
            font-weight: 500;
            text-align: center;
            line-height: 1.2;
        }
        
        /* Badge for notifications */
        .nav-badge {
            position: absolute;
            top: 2px;
            right: 8px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .nav-item {
            position: relative;
        }
        
        /* Card styles for mobile content */
        .mobile-card {
            {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}
            background: #ffffff;
            border: 1px solid #e9ecef;
            {% else %}
            background: #2d2d2d;
            border: 1px solid #3a3a3a;
            {% endif %}
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        /* Quick action buttons */
        .quick-action-btn {
            {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}
            background: linear-gradient(135deg, #6E7E85, #B7CECE);
            {% else %}
            background: linear-gradient(135deg, #B7CECE, #E2E2E2);
            {% endif %}
            border: none;
            color: {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}white{% else %}#1C0F13{% endif %};
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .quick-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            color: white;
            text-decoration: none;
        }
        
        /* Status indicators */
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-online { background: #28a745; }
        .status-busy { background: #ffc107; }
        .status-offline { background: #6c757d; }
        
        /* Responsive improvements */
        @media (max-width: 375px) {
            .nav-item .nav-label {
                font-size: 10px;
            }
            .nav-item .nav-icon {
                width: 22px;
                height: 22px;
            }
            .mobile-content {
                padding: 15px 0px;
            }
        }
        
        /* Dropdown menu styling */
        .dropdown-menu {
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            border: none;
            min-width: 200px;
        }
        
        .dropdown-item {
            padding: 10px 16px;
            border-radius: 8px;
            margin: 2px 8px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
        }
        
        .dropdown-item:hover {
            {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}
            background: #f8f9fa !important;
            color: #495057 !important;
            {% else %}
            background: #3a3a3a !important;
            color: #ffffff !important;
            {% endif %}
        }
        
        /* Hide dropdown arrows from select elements in modals - iOS specific */
        .modal select.form-select,
        .modal select,
        select[name="timezone"] {
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            appearance: none !important;
            background-image: none !important;
            background: transparent !important;
            border: 1px solid #ced4da !important;
            border-radius: 0.375rem !important;
            padding: 0.375rem 0.75rem !important;
        }
        
        /* Dark theme select styling */
        .modal select.form-select[style*="background: #1a1a1a"],
        .modal select[style*="background: #1a1a1a"] {
            background: #1a1a1a !important;
            background-image: none !important;
            color: #ffffff !important;
            border: 1px solid #3a3a3a !important;
        }
        
        /* Remove all possible select arrows */
        .modal select.form-select::-ms-expand,
        .modal select::-ms-expand,
        select[name="timezone"]::-ms-expand {
            display: none !important;
        }
        
        .modal select.form-select::-webkit-select-arrow,
        .modal select::-webkit-select-arrow,
        select[name="timezone"]::-webkit-select-arrow {
            display: none !important;
        }
        
        /* Custom timezone selector styling */
        .custom-timezone-selector {
            border: 1px solid {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#ced4da{% else %}#3a3a3a{% endif %};
            border-radius: 0.375rem;
            {% if current_user.is_authenticated and current_user.theme_preference != 'light' %}
            background: #1a1a1a;
            {% else %}
            background: #ffffff;
            {% endif %}
        }
        
        .timezone-option {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#f8f9fa{% else %}#2a2a2a{% endif %};
            {% if current_user.is_authenticated and current_user.theme_preference != 'light' %}
            color: #ffffff;
            {% else %}
            color: #212529;
            {% endif %}
        }
        
        .timezone-option:last-child {
            border-bottom: none;
        }
        
        .timezone-option:hover {
            {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}
            background: #f8f9fa;
            {% else %}
            background: #2a2a2a;
            {% endif %}
        }
        
        .timezone-option.selected {
            {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}
            background: #e3f2fd;
            color: #1976d2;
            {% else %}
            background: #1a4480;
            color: #66d9ef;
            {% endif %}
            font-weight: 500;
        }
        
        .timezone-option.selected:hover {
            {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}
            background: #e3f2fd;
            {% else %}
            background: #1a4480;
            {% endif %}
        }
        
        /* Page-specific active states */
        body.page-dashboard .nav-item[href*="dashboard"] { {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}color: #007bff; background: rgba(0, 123, 255, 0.1);{% else %}color: #66d9ef; background: rgba(102, 217, 239, 0.1);{% endif %} }
        body.page-schedule .nav-item[href*="calendar"] { {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}color: #007bff; background: rgba(0, 123, 255, 0.1);{% else %}color: #66d9ef; background: rgba(102, 217, 239, 0.1);{% endif %} }
        body.page-tickets .nav-item[href*="tickets"] { {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}color: #007bff; background: rgba(0, 123, 255, 0.1);{% else %}color: #66d9ef; background: rgba(102, 217, 239, 0.1);{% endif %} }
        body.page-quicklinks .nav-item[href*="quicklinks"] { {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}color: #007bff; background: rgba(0, 123, 255, 0.1);{% else %}color: #66d9ef; background: rgba(102, 217, 239, 0.1);{% endif %} }
    </style>
</head>
<body {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}class="light-theme"{% endif %}>
    
    <!-- Top Header -->
    <header class="mobile-header">
        <div class="logo">
            <img src="{% if current_user.is_authenticated and current_user.theme_preference == 'light' %}{{ url_for('static', filename=site_logo) }}{% else %}{{ url_for('static', filename='tbn_logo_dark.png') }}{% endif %}?v=2" alt="{{ site_name }}">
            <span>{{ site_name.upper() }}</span>
        </div>
        <div class="header-actions">
            {% if current_user.is_authenticated %}
            <div class="dropdown">
                <button class="btn btn-link p-0" type="button" data-bs-toggle="dropdown" aria-expanded="false" style="border: none; background: none; {% if current_user.theme_preference == 'light' %}color: #495057;{% else %}color: #ffffff;{% endif %}">
                    <i data-feather="user" style="width: 22px; height: 22px;"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" style="{% if current_user.theme_preference != 'light' %}background: #2d2d2d; border: 1px solid #3a3a3a;{% endif %}">
                    <li><h6 class="dropdown-header" style="{% if current_user.theme_preference != 'light' %}color: #ffffff;{% endif %}">{{ current_user.username }}</h6></li>
                    <li><hr class="dropdown-divider" style="{% if current_user.theme_preference != 'light' %}border-color: #3a3a3a;{% endif %}"></li>
                    
                    <!-- Theme Toggle -->
                    <li>
                        <form method="POST" action="{{ url_for('toggle_theme') }}" style="margin: 0;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="dropdown-item" style="{% if current_user.theme_preference != 'light' %}color: #ffffff; background: transparent;{% endif %}">
                                <i data-feather="{% if current_user.theme_preference == 'light' %}moon{% else %}sun{% endif %}" style="width: 16px; height: 16px; margin-right: 8px;"></i>
                                {% if current_user.theme_preference == 'light' %}Dark Mode{% else %}Light Mode{% endif %}
                            </button>
                        </form>
                    </li>
                    
                    <!-- Timezone Settings -->
                    <li>
                        <a class="dropdown-item" href="#" onclick="showTimezoneModal()" style="{% if current_user.theme_preference != 'light' %}color: #ffffff; background: transparent;{% endif %}">
                            <i data-feather="clock" style="width: 16px; height: 16px; margin-right: 8px;"></i>
                            Timezone ({{ current_user.timezone }})
                        </a>
                    </li>
                    
                    <li><hr class="dropdown-divider" style="{% if current_user.theme_preference != 'light' %}border-color: #3a3a3a;{% endif %}"></li>
                    
                    <!-- Profile Settings -->
                    <li>
                        <a class="dropdown-item" href="{{ url_for('profile') }}" style="{% if current_user.theme_preference != 'light' %}color: #ffffff; background: transparent;{% endif %}">
                            <i data-feather="settings" style="width: 16px; height: 16px; margin-right: 8px;"></i>
                            Profile Settings
                        </a>
                    </li>
                    
                    <!-- Logout -->
                    <li>
                        <a class="dropdown-item text-danger" href="{{ url_for('auth.logout') }}" style="{% if current_user.theme_preference != 'light' %}color: #ff6b6b;{% endif %}">
                            <i data-feather="log-out" style="width: 16px; height: 16px; margin-right: 8px;"></i>
                            Logout
                        </a>
                    </li>
                </ul>
            </div>
            {% endif %}
        </div>
    </header>

    <!-- Main Content -->
    <main class="mobile-content">
        {% block content %}{% endblock %}
    </main>

    <!-- Bottom Navigation -->
    {% if current_user.is_authenticated %}
    <nav class="bottom-nav">
        <a href="{{ url_for('mobile_dashboard') }}" class="nav-item">
            <i data-feather="home" class="nav-icon"></i>
            <span class="nav-label">Dashboard</span>
        </a>
        <a href="{{ url_for('mobile_personal_schedule') }}" class="nav-item" id="dynamic-nav-item">
            <i data-feather="calendar" class="nav-icon" id="dynamic-nav-icon"></i>
            <span class="nav-label" id="dynamic-nav-label">Schedule</span>
        </a>
        <a href="{{ url_for('mobile_tickets') }}" class="nav-item">
            <i data-feather="life-buoy" class="nav-icon"></i>
            <span class="nav-label">Tickets</span>
            <span class="nav-badge" id="ticket-badge" style="display: none;">0</span>
        </a>
        <a href="{{ url_for('mobile_quick_links') }}" class="nav-item">
            <i data-feather="grid" class="nav-icon"></i>
            <span class="nav-label">Quick Links</span>
        </a>
    </nav>
    {% endif %}

    <!-- Quick Links Modal -->
    <div class="modal fade" id="quickLinksModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="{% if current_user.is_authenticated and current_user.theme_preference == 'light' %}background: #ffffff; color: #212529;{% else %}background: #2d2d2d; color: #ffffff; border: 1px solid #3a3a3a;{% endif %}">
                <div class="modal-header" style="border-bottom: 1px solid {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#e9ecef{% else %}#3a3a3a{% endif %};">
                    <h5 class="modal-title">Quick Links</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" {% if current_user.is_authenticated and current_user.theme_preference != 'light' %}style="filter: invert(1);"{% endif %}></button>
                </div>
                <div class="modal-body">
                    <div id="quickLinksContent" class="d-grid gap-3">
                        <!-- Quick links will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Timezone Modal -->
    <div class="modal fade" id="timezoneModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="{% if current_user.is_authenticated and current_user.theme_preference == 'light' %}background: #ffffff; color: #212529;{% else %}background: #2d2d2d; color: #ffffff; border: 1px solid #3a3a3a;{% endif %}">
                <div class="modal-header" style="border-bottom: 1px solid {% if current_user.is_authenticated and current_user.theme_preference == 'light' %}#e9ecef{% else %}#3a3a3a{% endif %};">
                    <h5 class="modal-title">
                        <i data-feather="clock" style="width: 20px; height: 20px; margin-right: 8px;"></i>
                        Change Timezone
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" {% if current_user.is_authenticated and current_user.theme_preference != 'light' %}style="filter: invert(1);"{% endif %}></button>
                </div>
                <div class="modal-body">
                    <form method="POST" action="{{ url_for('update_timezone') }}" id="timezoneForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="timezone" id="selectedTimezone" value="{{ current_user.timezone }}">
                        <div class="mb-3">
                            <label class="form-label" style="{% if current_user.theme_preference != 'light' %}color: #ffffff;{% endif %}">Select Your Timezone:</label>
                            
                            <!-- Custom dropdown without arrows -->
                            <div class="custom-timezone-selector">
                                <div class="timezone-options">
                                    <div class="timezone-option {% if current_user.timezone == 'America/Chicago' %}selected{% endif %}" data-value="America/Chicago">
                                        <i data-feather="clock" style="width: 16px; height: 16px; margin-right: 8px;"></i>
                                        Central Time (CST/CDT)
                                    </div>
                                    <div class="timezone-option {% if current_user.timezone == 'America/Los_Angeles' %}selected{% endif %}" data-value="America/Los_Angeles">
                                        <i data-feather="clock" style="width: 16px; height: 16px; margin-right: 8px;"></i>
                                        Pacific Time (PST/PDT)
                                    </div>
                                    <div class="timezone-option {% if current_user.timezone == 'America/New_York' %}selected{% endif %}" data-value="America/New_York">
                                        <i data-feather="clock" style="width: 16px; height: 16px; margin-right: 8px;"></i>
                                        Eastern Time (EST/EDT)
                                    </div>
                                    <div class="timezone-option {% if current_user.timezone == 'America/Denver' %}selected{% endif %}" data-value="America/Denver">
                                        <i data-feather="clock" style="width: 16px; height: 16px; margin-right: 8px;"></i>
                                        Mountain Time (MST/MDT)
                                    </div>
                                    <div class="timezone-option {% if current_user.timezone == 'UTC' %}selected{% endif %}" data-value="UTC">
                                        <i data-feather="clock" style="width: 16px; height: 16px; margin-right: 8px;"></i>
                                        UTC
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i data-feather="check" style="width: 16px; height: 16px; margin-right: 8px;"></i>
                                Update Timezone
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    
    <script>
        // Initialize Feather icons
        document.addEventListener('DOMContentLoaded', function() {
            feather.replace();
            
            // Set active navigation state based on current page
            const currentPath = window.location.pathname;
            const navItems = document.querySelectorAll('.nav-item');
            
            navItems.forEach(item => {
                const href = item.getAttribute('href');
                if (href && href !== '#' && currentPath.includes(href.split('?')[0])) {
                    item.classList.add('active');
                }
            });
            
            // Load ticket badge count
            loadTicketBadge();
            
            // Auto-refresh ticket badge every 30 seconds
            setInterval(loadTicketBadge, 30000);
            
            // Update dynamic navigation based on current page
            updateDynamicNavigation();
        });
        
        // Update dynamic navigation based on current page
        function updateDynamicNavigation() {
            const currentPath = window.location.pathname;
            const dynamicNavItem = document.getElementById('dynamic-nav-item');
            const dynamicNavLabel = document.getElementById('dynamic-nav-label');
            const dynamicNavIcon = document.getElementById('dynamic-nav-icon');
            
            if (currentPath.includes('/mobile/personal_schedule')) {
                // On Personal Schedule page - show "Timeline" to go back to calendar
                dynamicNavLabel.textContent = 'Timeline';
                dynamicNavItem.href = '{{ url_for("mobile_calendar") }}';
                dynamicNavIcon.setAttribute('data-feather', 'clock');
            } else if (currentPath.includes('/mobile/calendar')) {
                // On Calendar page - show "Schedule" to go to personal schedule
                dynamicNavLabel.textContent = 'Schedule';
                dynamicNavItem.href = '{{ url_for("mobile_personal_schedule") }}';
                dynamicNavIcon.setAttribute('data-feather', 'calendar');
            } else {
                // Default state - show "Schedule" for personal schedule
                dynamicNavLabel.textContent = 'Schedule';
                dynamicNavItem.href = '{{ url_for("mobile_personal_schedule") }}';
                dynamicNavIcon.setAttribute('data-feather', 'calendar');
            }
            
            // Re-initialize feather icons to apply icon changes
            feather.replace();
        }
        
        // Load ticket count for badge
        function loadTicketBadge() {
            fetch('/api/active-tickets-count')
                .then(response => response.json())
                .then(data => {
                    const badge = document.getElementById('ticket-badge');
                    if (data.count > 0) {
                        badge.textContent = data.count > 99 ? '99+' : data.count;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.log('Could not load ticket count:', error);
                });
        }
        
        // Show timezone modal
        function showTimezoneModal() {
            const modal = new bootstrap.Modal(document.getElementById('timezoneModal'));
            modal.show();
            // Re-initialize icons after modal shows
            setTimeout(() => feather.replace(), 100);
            
            // Add click handlers for timezone options
            document.querySelectorAll('.timezone-option').forEach(option => {
                option.addEventListener('click', function() {
                    // Remove selected class from all options
                    document.querySelectorAll('.timezone-option').forEach(opt => opt.classList.remove('selected'));
                    
                    // Add selected class to clicked option
                    this.classList.add('selected');
                    
                    // Update hidden input value
                    document.getElementById('selectedTimezone').value = this.getAttribute('data-value');
                });
            });
        }
        
        // Show quick links modal
        function showQuickLinks() {
            fetch('/api/quick-links')
                .then(response => response.json())
                .then(data => {
                    const content = document.getElementById('quickLinksContent');
                    content.innerHTML = '';
                    
                    if (data.quick_links && data.quick_links.length > 0) {
                        data.quick_links.forEach(link => {
                            const linkElement = document.createElement('a');
                            linkElement.href = link.url;
                            linkElement.target = '_blank';
                            linkElement.className = 'quick-action-btn';
                            linkElement.innerHTML = `
                                <i data-feather="${link.icon}" style="width: 18px; height: 18px;"></i>
                                ${link.title}
                            `;
                            content.appendChild(linkElement);
                        });
                        feather.replace();
                    } else {
                        content.innerHTML = '<p class="text-muted text-center">No quick links available</p>';
                    }
                    
                    const modal = new bootstrap.Modal(document.getElementById('quickLinksModal'));
                    modal.show();
                })
                .catch(error => {
                    console.log('Could not load quick links:', error);
                });
        }
        
        // Chat integration
        {% if CHAT_ENABLED %}
        function openChatPopup() {
            // Integrate with existing chat system
            if (typeof window.openChatPopup === 'function') {
                window.openChatPopup();
            }
        }
        {% endif %}
    </script>
    
    {% block scripts %}{% endblock %}
</body>
</html>